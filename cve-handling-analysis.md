# CVE Handling Analysis: VersionIndex vs ShipIndex

## Current State

### Graph Structure Asymmetry

**ShipIndex (History Graph):**
- Goes down to month level: `release-history/2024/05/index.json`
- Uses `disclosures` (the newer, preferred scheme)
- Includes full CVE detail at month level with:
  - CVSS scores
  - Disclosure dates
  - Fix commit links
  - Affected products/packages/releases

**VersionIndex (Version Graph):**
- Currently stops at major version: `9.0/index.json`
- Uses older `cve-records` format
- Shows CVE IDs at patch level but not full disclosure data

### The Asymmetry Issue

You correctly identified that the version graph should mirror the history graph depth:

**Current:**
```
9.0/index.json → contains patch releases → each patch has cve-records
```

**Proposed:**
```
9.0/index.json → should contain string[] for cve-records (just IDs)
9.0/9.0.0/index.json → should contain disclosures (full CVE details)
```

This would make it symmetric with:
```
release-history/2024/index.json → year level
release-history/2024/05/index.json → month level with full disclosures
```

## Code Locations

### Shared Code (DotnetRelease library)

**CVE Data Structures:**
- `DotnetRelease/Security/CveRecords.cs` - Full CVE disclosure schema
  - `Cve` - Full disclosure record with CVSS, timeline, etc.
  - `CveRecords` - Container with products, packages, commits
  - Uses `disclosures` as property name

- `DotnetRelease/Security/CveSummary.cs` - Simplified for indexes
  - `CveRecordSummary` - Lightweight CVE reference
  - `CommitLink` - Fix commit information

**Graph Structures:**
- `DotnetRelease/Graph/ReleaseVersionIndex.cs` - Legacy structures
  - `ReleaseVersionIndexEntry` - Has `CveRecords` property
  
- `DotnetRelease/Graph/PatchReleaseVersionIndex.cs` - Newer structures
  - `PatchReleaseVersionIndexEntry` - Also has `CveRecords` property

### Tool-Specific Code

**VersionIndex:**
- `VersionIndex/ReleaseIndexFiles.cs` (lines 560-575)
  - Reads CVE data from `summary.CveList`
  - Creates `CveRecordSummary` objects
  - Adds to patch release entries
  - Currently embeds CVE records at the major version index level

**ShipIndex:**
- `ShipIndex/ShipIndexFiles.cs` (lines 130-243)
  - Loads `cve.json` files from month directories
  - Deserializes to `CveRecords` with full `Disclosures`
  - Converts to `CveRecordSummary` for embedding in month indexes
  - Uses the newer disclosure format throughout

## Key Differences

### Data Format
1. **ShipIndex** uses the full `disclosures` schema from `CveRecords`
2. **VersionIndex** uses simplified `cve-records` with just ID and URL

### Data Depth
1. **ShipIndex** puts full CVE details at the month level
2. **VersionIndex** puts CVE summaries at the major version level (should be patch level)

## Proposed Changes

### 1. Create Common CVE Handler Library

Extract shared CVE handling logic:

```
src/CveHandler/
  ├── CveLoader.cs           # Load CVE data from JSON files
  ├── CveTransformer.cs      # Convert between formats
  └── CveValidator.cs        # Ensure consistency
```

### 2. Standardize on `disclosures` Format

Both tools should use the newer format:
- Month-level files: `release-history/2024/05/cve.json` (disclosures)
- Patch-level files: `9.0/9.0.0/cve.json` (disclosures) - NEW

### 3. Fix Version Index Depth

**Current structure:**
```json
{
  "kind": "index",
  "_embedded": {
    "releases": [
      {
        "version": "9.0.0",
        "cve-records": [...]  // CVE details here
      }
    ]
  }
}
```

**Proposed structure:**
```json
// 9.0/index.json (major version)
{
  "kind": "index",
  "cve-records": ["CVE-2025-30399", "CVE-2025-26646"],  // Just IDs
  "_embedded": {
    "releases": [
      {
        "version": "9.0.0",
        "cve-records": ["CVE-2024-43498", "CVE-2024-43499"]  // Just IDs
      }
    ]
  }
}

// 9.0/9.0.0/index.json (patch version) - NEW FILE
{
  "kind": "patch-index",
  "version": "9.0.0",
  "_links": {
    "self": "...",
    "cve": "9.0/9.0.0/cve.json"
  },
  "disclosures": [
    {
      "id": "CVE-2024-43498",
      "problem": "...",
      "cvss": {...},
      "timeline": {...},
      // Full disclosure details
    }
  ]
}
```

### 4. Common Processing Pipeline

Both tools should follow the same pattern:

1. **Load** CVE data from source files
2. **Validate** schema and required fields
3. **Transform** to appropriate depth:
   - Summary level: Just CVE IDs (string[])
   - Detail level: Full disclosures
4. **Embed** in index at appropriate level

## Benefits of Proposed Changes

1. **Consistency**: Both indexes use same CVE format
2. **Symmetry**: Both graphs have same depth (major/year → patch/month)
3. **Maintainability**: Shared code reduces duplication
4. **Flexibility**: Easy to add new CVE-related features
5. **Clarity**: Clear separation between summary (IDs) and detail (disclosures)

## Implementation Order

1. Create `CveHandler` library with common utilities
2. Update `VersionIndex` to generate patch-level index files
3. Adopt `disclosures` format in `VersionIndex`
4. Refactor both tools to use shared `CveHandler`
5. Update documentation and schemas

## Files to Create/Modify

### New Files
- `src/CveHandler/CveHandler.csproj`
- `src/CveHandler/CveLoader.cs`
- `src/CveHandler/CveTransformer.cs`
- `9.0/9.0.0/index.json` (and other patch indexes)
- `9.0/9.0.0/cve.json` (CVE details per patch)

### Modified Files
- `VersionIndex/ReleaseIndexFiles.cs` - Use CveHandler, generate patch indexes
- `ShipIndex/ShipIndexFiles.cs` - Use CveHandler
- `VersionIndex/VersionIndex.csproj` - Add CveHandler reference
- `ShipIndex/ShipIndex.csproj` - Add CveHandler reference
