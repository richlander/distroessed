# CVE Handling Implementation Summary

## Overview
This implementation creates symmetry between ShipIndex and VersionIndex for CVE handling, following the analysis in `cve-handling-analysis.md`.

## Changes Made

### 1. Created CveHandler Library (`src/CveHandler/`)
A new shared library for common CVE processing logic:

- **CveLoader.cs**: Loads CVE data from JSON files
  - `LoadCveRecordsAsync()`: Loads CVE records from a cve.json file
  - `LoadCveRecordsFromDirectoryAsync()`: Loads CVE records from a directory

- **CveTransformer.cs**: Transforms CVE data between formats
  - `ToSummaries()`: Converts full CVE disclosures to summary format for indexes
  - `ExtractCveIds()`: Extracts just CVE IDs from records
  - `FilterByRelease()`: Filters CVE records for a specific release version

### 2. New Graph Structure (`src/DotnetRelease/Graph/`)

- **PatchDetailIndex.cs**: New structure for patch-level detail indexes
  - Contains full CVE disclosures (using `disclosures` property)
  - Mirrors the structure of month-level indexes in ShipIndex
  - Example: `9.0/9.0.0/index.json` with full CVE details

### 3. Updated Graph Structures

**PatchReleaseVersionIndex.cs**:
- Added `CveRecords` property at major version level (list of CVE IDs)
- This provides a summary of all CVEs affecting the major version

**PatchReleaseVersionIndexEntry.cs**:
- Changed `CveRecords` from `IReadOnlyList<CveRecordSummary>` to `IReadOnlyList<string>`
- Now contains just CVE IDs instead of full summary objects

**ReleaseVersionIndexEntry.cs** (legacy):
- Changed `CveRecords` to `IReadOnlyList<string>` for consistency

**PatchSummary.cs**:
- Updated to reflect CVE IDs instead of full records

### 4. VersionIndex Tool Updates (`src/VersionIndex/`)

**ReleaseIndexFiles.cs**:
- Updated `GetPatchIndexEntriesAsync()` to:
  - Extract CVE IDs for patch index entries
  - Generate patch-level detail index files with full CVE disclosures
  - Add links to patch detail indexes

- Added `GeneratePatchDetailIndexAsync()` to:
  - Load CVE data for a major version
  - Filter CVE records by patch release
  - Generate detailed patch index with full CVE disclosures
  - Write `{major}/{patch}/index.json` files

- Updated major version index generation to:
  - Use `PatchReleaseVersionIndex` structure
  - Collect all CVE IDs from patches
  - Include CVE IDs at major version level

### 5. ShipIndex Tool Updates (`src/ShipIndex/`)

**ShipIndexFiles.cs**:
- Replaced inline CVE transformation logic with `CveHandler.CveTransformer.ToSummaries()`
- Uses `CveHandler.CveLoader.LoadCveRecordsFromDirectoryAsync()` for loading
- Simplified code by removing duplicate transformation logic

## Benefits

1. **Consistency**: Both indexes now use the same CVE format and terminology
2. **Symmetry**: Version graph now has the same depth as history graph
   - Major version level: CVE IDs only
   - Patch/Month level: Full CVE disclosures
3. **Maintainability**: Shared code reduces duplication
4. **Flexibility**: Easy to add new CVE-related features
5. **Clarity**: Clear separation between summary (IDs) and detail (disclosures)

## File Structure

### Before:
```
9.0/
  ├── index.json          # Contains patch releases with CVE summaries
  ├── release.json
  └── releases.json
```

### After:
```
9.0/
  ├── index.json          # Contains patch releases with CVE IDs + major version CVE IDs
  ├── 9.0.0/
  │   └── index.json      # NEW: Detailed patch index with CVE disclosures
  ├── 9.0.1/
  │   └── index.json      # NEW: Detailed patch index with CVE disclosures
  ├── release.json
  └── releases.json
```

This mirrors the ShipIndex structure:
```
release-history/
  ├── 2024/
  │   ├── index.json      # Year level with month summaries
  │   ├── 05/
  │   │   ├── index.json  # Month level with CVE disclosures
  │   │   └── cve.json
```

## Backward Compatibility

- Legacy `ReleaseVersionIndex` and `ReleaseVersionIndexEntry` structures maintained
- Changed `CveRecords` from full objects to string IDs (breaking change)
- Clients should update to expect CVE IDs and fetch details from patch-level indexes

## Testing

All projects build successfully:
- CveHandler library
- DotnetRelease library with new structures
- VersionIndex tool with new generation logic
- ShipIndex tool with shared CVE handler
- Full solution builds without errors
